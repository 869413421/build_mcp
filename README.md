# å·¥ç¨‹åŒ–æ„å»ºä¸€ä¸ªMCPæœåŠ¡ï¼Œä»å¼€å‘è°ƒè¯•åˆ°éƒ¨ç½²ä¸Šçº¿

MCPæœ‰å¤šç«ï¼Œå·²ç»ä¸éœ€è¦æˆ‘å†èµ˜è¿°ã€‚ä½œä¸ºä¸€é¡¹æ–°å…´æŠ€æœ¯ï¼Œä¸­æ–‡äº’è”ç½‘ä¸Šå¯¹å¦‚ä½•å¼€å‘MCPæœåŠ¡çš„èµ„æ–™å¤šå¦‚ç‰›æ¯›ï¼Œä½†å¤§å¤šæ•°è¯­ç„‰ä¸è¯¦æˆ–è€…æµ…å°è¾„æ­¢ï¼Œå¤§å¤šæ•°æ¡ˆä¾‹éƒ½æ˜¯ç…§æ¬å®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹ç®€è¿°ä¸€ä¸‹æ°´æ–‡ã€‚
ä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œæˆ‘æ·±çŸ¥å·¥ç¨‹åŒ–çš„é‡è¦æ€§ã€‚MCPæœåŠ¡çš„å¼€å‘ä¸ä»…ä»…æ˜¯ç…§çŒ«ç”»è™å†™ä¸¤ä¸ªæœåŠ¡æ¥å£é‚£ä¹ˆç®€å•ï¼Œæ›´éœ€è¦è€ƒè™‘åˆ°ä»£ç ç»“æ„ã€é…ç½®ç®¡ç†ã€æ—¥å¿—è®°å½•ã€å¼‚å¸¸å¤„ç†ç­‰æ–¹æ–¹é¢é¢ã€‚ç»è¿‡æ¢ç´¢å’Œå®è·µï¼Œæˆ‘å¸Œæœ›å°†ä¸€ä¸ªMCPæœåŠ¡çš„å¼€å‘æµç¨‹æ•´ç†æˆäº†ä¸€ä»½è¯¦å°½çš„æŒ‡å—ï¼Œå¸Œæœ›èƒ½å¸®åŠ©æ›´å¤šçš„å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å¹¶æ„å»ºå‡ºé«˜è´¨é‡çš„MCPæœåŠ¡ã€‚

---

## æ„å»ºä¸€ä¸ªä»€ä¹ˆæ ·çš„MCPæœåŠ¡ï¼Ÿ

ä¸ºäº†è®©æˆ‘ä»¬æœ‰æ›´å¥½åœ°å®è·µç›®æ ‡ï¼Œæˆ‘ä»¬ç®€å•æ„å»ºä¸€ä¸ªåŸºäºé«˜å¾·åœ°å›¾APIçš„MCP æœåŠ¡ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### [æ ¹æ®ç”¨æˆ·ipè·å–ç”¨æˆ·çš„åœ°ç†ä½ç½®](https://lbs.amap.com/api/webservice/guide/api/ipconfig)

- å‚æ•°ï¼š`ipåœ°å€(å¯é€‰ï¼Œä¸ä¼ é€’é»˜è®¤è·å–å½“å‰ä¸»æœºIP)`
- è¿”å›ï¼šç”¨æˆ·çš„ç»çº¬åº¦ä¿¡æ¯

### [æ ¹æ®ç”¨æˆ·çš„åœ°ç†ä½ç½®è·å–é™„è¿‘çš„POIä¿¡æ¯](https://lbs.amap.com/api/webservice/guide/api-advanced/newpoisearch)

- å‚æ•°ï¼š`ç»åº¦ã€çº¬åº¦ã€POIç±»å‹`
- è¿”å›ï¼šé™„è¿‘çš„POIä¿¡æ¯åˆ—è¡¨

å®Œæˆä»¥ä¸ŠåŠŸèƒ½åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¤§æ¨¡å‹å¯¹è¯çš„è·å–çœŸå®çš„POIä¿¡æ¯ï¼Œä¸¾ä¸ªä¾‹å­ã€‚

- ç”¨æˆ·ï¼šæˆ‘æƒ³çŸ¥é“æˆ‘é™„è¿‘çš„é¤é¦†æœ‰å“ªäº›ï¼Ÿ
- MCPæœåŠ¡ï¼šæ ¹æ®æ‚¨çš„ä½ç½®ï¼Œé™„è¿‘æœ‰ä»¥ä¸‹é¤é¦†ï¼š1. é¤é¦†A 2. é¤é¦†B 3. é¤é¦†C
- ç”¨æˆ·ï¼šé¤é¦†Açš„åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ
- MCPæœåŠ¡ï¼šé¤é¦†Açš„åœ°å€æ˜¯ï¼š
    - åœ°å€ï¼šXXX
    - ç”µè¯ï¼šXXX
    - è¥ä¸šæ—¶é—´ï¼šXXX

---

## æ ¸å¿ƒ MCP æ¦‚å¿µ

å¦‚æœåœ¨å¼€å§‹ä¹‹å‰ä½ å¯¹MCPæ˜¯ä»€ä¹ˆå®Œå…¨æ²¡æœ‰æ¦‚å¿µï¼Œå»ºè®®å…ˆé˜…è¯» [MCP å®˜æ–¹æ–‡æ¡£](https://modelcontextprotocol.io/introduction) äº†è§£åŸºæœ¬æ¦‚å¿µã€‚

MCP æœåŠ¡å™¨å¯ä»¥æä¾›ä¸‰ç§ä¸»è¦ç±»å‹çš„åŠŸèƒ½ï¼š

- Resources: èµ„æºï¼Œå®¢æˆ·ç«¯å¯ä»¥è¯»å–çš„ç±»ä¼¼æ–‡ä»¶çš„æ•°æ®ï¼ˆå¦‚ API å“åº”æˆ–æ–‡ä»¶å†…å®¹ï¼‰

- Tools: å·¥å…· ï¼ŒLLM å¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼ˆç»ç”¨æˆ·æ‰¹å‡†ï¼‰

- Prompts: æç¤º ï¼Œå¸®åŠ©ç”¨æˆ·å®Œæˆç‰¹å®šä»»åŠ¡çš„é¢„å…ˆç¼–å†™çš„æ¨¡æ¿

---

## å¿…å¤‡çŸ¥è¯†

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå»ºè®®æ‚¨å…·å¤‡ä»¥ä¸‹çŸ¥è¯†ï¼š

- Python åŸºç¡€
- LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰æ¦‚å¿µ
- UV ï¼ˆPython åŒ…ç®¡ç†å·¥å…·ï¼‰

---

## ç³»ç»Ÿè¦æ±‚

- Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬
- Python MCP SDK 1.2.0

---

## é…ç½®å¼€å‘ç¯å¢ƒ

**âš  è¯·åŠ¡å¿…æ ¹æ®è‡ªå·±çš„æ“ä½œç³»ç»Ÿè°ƒæ•´å‘½ä»¤ï¼Œpowershell å’Œ bash çš„å‘½ä»¤è¯­æ³•æœ‰æ‰€ä¸åŒã€‚**

ä½œè€…ä½¿ç”¨çš„æ˜¯windows+gitç»ˆç«¯ã€‚
æœ¬æ•™ç¨‹å‰åŠæ®µä¸å®˜æ–¹åŸºæœ¬æ— å¼‚ï¼Œå¯æŸ¥è€ƒå®˜æ–¹æ–‡æ¡£ä¸­[serverå¼€å‘ç¤ºä¾‹](https://modelcontextprotocol.io/quickstart/server)ã€‚

### å®‰è£…UV

```shell
# Linux or macOS
curl -LsSf https://astral.sh/uv/install.sh | sh
```

```shell
# Windows
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### åˆ›å»ºè™šæ‹Ÿç¯å¢ƒåˆå§‹åŒ–é¡¹ç›®

```shell
# ä½¿ç”¨UVåˆ›å»ºå¹¶è¿›å…¥é¡¹ç›®ç›®å½•
uv init build-mcp
cd build-mcp

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv
source .venv/Scripts/activate

# å®‰è£…ç›¸å…³ä¾èµ–
uv add mcp[cli] httpx pytest
```

---

## è§„åˆ’é¡¹ç›®ç›®å½•ç»“æ„ï¼ˆæ¨è `src/` å¸ƒå±€ï¼‰

```plaintext
build-mcp/
â”œâ”€â”€ src/                         # æ ¸å¿ƒæºç ç›®å½•ï¼ˆPythonåŒ…ï¼‰
â”‚   â””â”€â”€ build_mcp/               # ä¸»åŒ…å‘½åç©ºé—´
â”‚       â”œâ”€â”€ __init__.py          # åŒ…åˆå§‹åŒ–æ–‡ä»¶
â”‚       â”œâ”€â”€ __main__.py          # å‘½ä»¤è¡Œå…¥å£ç‚¹
â”‚       â”œâ”€â”€ common/              # é€šç”¨åŠŸèƒ½æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ config.py        # é…ç½®ç®¡ç†
â”‚       â”‚   â””â”€â”€ logger.py        # æ—¥å¿—ç³»ç»Ÿ
â”‚       â””â”€â”€ services/            # ä¸šåŠ¡æœåŠ¡æ¨¡å—
â”‚           â”œâ”€â”€ gd_sdk.py        # é«˜å¾·æœåŠ¡é›†æˆ
â”‚           â””â”€â”€ server.py        # ä¸»æœåŠ¡å®ç°
â”œâ”€â”€ tests/                       # æµ‹è¯•å¥—ä»¶ç›®å½•
â”‚   â”œâ”€â”€ common/                  # é€šç”¨æ¨¡å—æµ‹è¯•
â”‚   â””â”€â”€ services/                # æœåŠ¡æ¨¡å—æµ‹è¯•
â”œâ”€â”€ docs/                        # é¡¹ç›®æ–‡æ¡£
â”‚   â””â”€â”€ buildâ€‘mcp é¡¹ç›®å¼€å‘æŒ‡å—.md # æ ¸å¿ƒæ–‡æ¡£
â”œâ”€â”€ pyproject.toml               # é¡¹ç›®æ„å»ºé…ç½®
â”œâ”€â”€ Makefile                     # è‡ªåŠ¨åŒ–å‘½ä»¤ç®¡ç†
â””â”€â”€ README.md                    # é¡¹ç›®æ¦‚è§ˆæ–‡æ¡£
```

### ç»“æ„è®¾è®¡è§£æ

#### æ ¸å¿ƒè®¾è®¡ï¼š`src/` å¸ƒå±€ï¼ˆå…³é”®ä¼˜åŠ¿ï¼‰

```plaintext
build-mcp/
â””â”€â”€ src/
    â””â”€â”€ mirakl_mcp/
        â”œâ”€â”€ ... 
```

**ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§ç»“æ„ï¼Ÿ**

- âœ… **éš”ç¦»å®‰è£…ç¯å¢ƒ**ï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰  
  æµ‹è¯•æ—¶å¼ºåˆ¶é€šè¿‡`pip install`å®‰è£…åŒ…ï¼Œé¿å…ç›´æ¥å¼•ç”¨æºç è·¯å¾„ï¼Œç¡®ä¿æµ‹è¯•ç¯å¢ƒ=ç”¨æˆ·è¿è¡Œç¯å¢ƒ
- âœ… **é˜²æ­¢éšå¼è·¯å¾„ä¾èµ–**  
  æ¶ˆé™¤å› å¼€å‘ç›®å½•åœ¨`sys.path`é¦–ä½å¯¼è‡´çš„é”™è¯¯å¯¼å…¥ï¼ˆå¸¸è§äºæ— `src/`çš„ä¼ ç»Ÿå¸ƒå±€ï¼‰
- âœ… **æ‰“åŒ…å®‰å…¨æ€§**  
  å¼ºåˆ¶éªŒè¯åŒ…å†…å®¹æ˜¯å¦è¢«æ­£ç¡®åŒ…å«åœ¨åˆ†å‘æ–‡ä»¶ä¸­ï¼ˆç¼ºå¤±æ–‡ä»¶åœ¨æµ‹è¯•ä¸­ä¼šç«‹å³æš´éœ²ï¼‰
- âœ… **å¤šç¯å¢ƒä¸€è‡´æ€§**  
  å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®Œå…¨ç›¸åŒåŒ…ç»“æ„ï¼Œæœç»"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"é—®é¢˜

> ğŸ“Š æ•°æ®æ”¯æŒï¼šPyPAå®˜æ–¹è°ƒæŸ¥æ˜¾ç¤ºï¼Œé‡‡ç”¨`src/`å¸ƒå±€çš„é¡¹ç›®æ‰“åŒ…é”™è¯¯ç‡é™ä½63%ï¼ˆ[æ¥æº](https://packaging.python.org/en/latest/discussions/src-layout-vs-flat-layout/))

---

## ç¼–å†™å·¥å…·ä»£ç 

è§„åˆ’å¥½ç›®å½•åæˆ‘ä»¬å¼€å§‹æ­£å¼è¿›è¡Œç¼–ç ï¼Œä¸€ä¸ªæ­£å¼è§„èŒƒçš„é¡¹ç›®å¯èƒ½æ¶‰åŠåˆ°éå¸¸å¤šçš„é¡¹ç›®é…ç½®è¯»å–ã€‚é¦–å…ˆç¬¬ä¸€æ­¥æˆ‘ä»¬å¯¹é…ç½®æ–‡ä»¶è¯»å–åŠŸèƒ½è¿›è¡Œå°è£…ã€‚

### ä½¿ç”¨`pyyaml`åŒ…æ¥ç®¡ç†é…ç½®

```shell
uv add pyyaml
```

### åˆ›å»ºé…ç½®ç®¡ç†æ¨¡å—

```shell
mkdir -p src/build_mcp/common
touch src/build_mcp/__init__.py
touch src/build_mcp/common/__init__.py
touch src/build_mcp/common/config.py
```

### åˆ›å»ºé…ç½®æ–‡ä»¶

```shell
touch src/build_mcp/config.yaml
```

åœ¨ `src/build_mcp/config.yaml` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```yaml
# é«˜å¾·åœ°å›¾APIé…ç½®
api_key: test
# é«˜å¾·åœ°å›¾APIçš„åŸºç¡€URL
base_url: https://restapi.amap.com
# ä»£ç†è®¾ç½®
proxy: http://127.0.0.1:10809
# æ—¥å¿—ç­‰çº§
log_level: INFO
# æ¥å£é‡è¯•æ¬¡æ•°
max_retries: 5
# æ¥å£é‡è¯•é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
retry_delay: 1
# æŒ‡æ•°é€€é¿å› å­
backoff_factor: 2
```

âš  `config.yaml` æ–‡ä»¶éœ€è¦æ”¾åœ¨ `src/build_mcp/` ç›®å½•ä¸‹ï¼Œè¿™æ ·åœ¨åŠ è½½é…ç½®æ—¶å¯ä»¥æ­£ç¡®æ‰¾åˆ°ã€‚

è¿™ä¸ªé…ç½®æ–‡ä»¶ä»…ä»…ä½œä¸ºä¸€ä¸ªå·¥ç¨‹åŒ–çš„ç¤ºä¾‹ï¼Œæ­£å¼ç¯å¢ƒä¸­ä¸è¦å°†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚APIå¯†é’¥ï¼‰ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å®‰å…¨å­˜å‚¨æœåŠ¡ã€‚

### ç¼–å†™é…ç½®ç®¡ç†ä»£ç 

```python
# src/build_mcp/common/config.py
import os

import yaml


def load_config(config_file="config.yaml") -> dict:
    """
    åŠ è½½é…ç½®æ–‡ä»¶ã€‚
  
    Args:
        config_file (str): é…ç½®æ–‡ä»¶çš„åç§°ï¼Œé»˜è®¤ä¸º "config.yaml"ã€‚
    Returns:
        dict: è¿”å›é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚
    Example:
        config = load_config("config.yaml")
        print(config)
    """
    # æ‰¾åˆ°æ ¹ç›®å½•ï¼ˆconfig.yaml å°±æ”¾æ ¹ç›®å½•ï¼‰
    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    config_path = os.path.join(base_dir, config_file)

    with open(config_path, "r", encoding="utf-8") as f:
        config = yaml.safe_load(f)
    return config

```

### å®‰è£…ä»£ç 

âš  é¦–æ¬¡å®‰è£…ä»£ç æ—¶éœ€è¦ä½¿ç”¨ `pip install -e .` å‘½ä»¤ï¼Œè¿™æ ·å¯ä»¥å°†å½“å‰ç›®å½•ä½œä¸ºä¸€ä¸ªå¯ç¼–è¾‘çš„åŒ…å®‰è£…åˆ°è™šæ‹Ÿç¯å¢ƒä¸­ã€‚è¿™æ ·åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯¹ä»£ç çš„ä¿®æ”¹ä¼šç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°å®‰è£…ã€‚

```shell
uv pip install -e .
```

### ç¼–å†™æµ‹è¯•ä»£ç 

é¡¹ç›®ä¸­å°½å¯èƒ½è¯¦å°½åœ°ç¼–å†™æµ‹è¯•ä»£ç æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚åœ¨é¡¹ç›®å·¥ç¨‹åŒ–ä¸­ï¼Œæˆ‘ä»¬å°½å¯èƒ½ä¸ºä¸€äº›æ ¸å¿ƒåŠŸèƒ½ç¼–å†™æµ‹è¯•ä»£ç ï¼Œä»¥ç¡®ä¿ä»£ç çš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚

```shell
mkdir -p tests/common
touch tests/common/test_config.py
```

```python
# tests/common/test_config.py
from build_mcp.common.config import load_config


def test_load_config():
    """æµ‹è¯•é…ç½®æ–‡ä»¶åŠ è½½åŠŸèƒ½"""
    config = load_config("config.yaml")
    assert config["api_key"] == "test"
    assert config["log_level"] == "INFO"

```

### è¿è¡Œæµ‹è¯•

```shell
uv run pytest tests
```

## ç¼–å†™æ—¥å¿—æ¨¡å—

ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæ˜¯å¦èƒ½å¤Ÿå¿«é€Ÿå®šä½é—®é¢˜ï¼Œæ—¥å¿—ç³»ç»Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚
ä¸€ä¸ªä¼˜ç§€çš„ç¨‹åºå‘˜ï¼Œä¸ä»…è¦ä¼šå†™ä»£ç ï¼Œè¿˜è¦ä¼šå†™æ—¥å¿—ã€‚æˆ‘ä»¬ç®€å•å°è£…ä¸€ä¸ªæ—¥å¿—æ¨¡å—ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚

```shell
touch src/build_mcp/common/logger.py
```

è¿™é‡Œæˆ‘ä»¬å®ç°ä¸€ä¸ªåŒæ—¶è¾“å‡ºæ§åˆ¶å°å’Œæ–‡ä»¶çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒæ—¥å¿—è½®è½¬å’Œå¤‡ä»½ã€‚

```python
# src/build_mcp/common/logger.py
import logging
from logging.handlers import RotatingFileHandler


def get_logger(
        name: str = "default",
        log_file: str = "app.log",
        log_level=logging.INFO,
        max_bytes=5 * 1024 * 1024,
        backup_count=3
) -> logging.Logger:
    """
    è·å–ä¸€ä¸ªå¸¦æ–‡ä»¶å’Œæ§åˆ¶å°è¾“å‡ºçš„ loggerã€‚
  
    Args:
        name (str): logger åç§°
        log_file (str): æ—¥å¿—æ–‡ä»¶è·¯å¾„
        log_level (int): æ—¥å¿—ç­‰çº§ï¼Œé»˜è®¤ä¸º logging.INFO
        max_bytes (int): å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆé»˜è®¤ 5MBï¼‰
        backup_count (int): æ—¥å¿—æ–‡ä»¶ä¿ç•™ä»½æ•°
    Returns:
        logging.Logger: é…ç½®å¥½çš„ logger å®ä¾‹
    Example:
        logger = get_logger("my_logger", "my_app.log", logging.DEBUG)
        logger.info("This is an info message.")
    """
    logger = logging.getLogger(name)
    logger.setLevel(log_level)

    if not logger.hasHandlers():  # é¿å…é‡å¤æ·»åŠ  handler
        # æ§åˆ¶å°è¾“å‡º
        console_handler = logging.StreamHandler()
        console_formatter = logging.Formatter('[%(asctime)s] %(levelname)s - %(message)s')
        console_handler.setFormatter(console_formatter)

        # æ–‡ä»¶è¾“å‡º
        file_handler = RotatingFileHandler(log_file, maxBytes=max_bytes, backupCount=backup_count, encoding='utf-8')
        file_formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
        file_handler.setFormatter(file_formatter)

        logger.addHandler(console_handler)
        logger.addHandler(file_handler)

    return logger

```

ç›®å‰ä¸ºæ­¢ï¼Œæ„å»ºä¸€ä¸ªç³»ç»Ÿçš„åŸºç¡€æ¨¡å—å·²ç»æ„å»ºå®Œæˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†å®ç°æ ¸å¿ƒçš„æœåŠ¡åŠŸèƒ½ã€‚

## ç¼–å†™é«˜å¾·åœ°å›¾è¯·æ±‚SDK

æ ¹æ®[é«˜å¾·åœ°å›¾APIæ–‡æ¡£](https://lbs.amap.com/api/webservice/guide/api/ipconfig)ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š

1. æ ¹æ®ç”¨æˆ·IPè·å–åœ°ç†ä½ç½®
2. æ ¹æ®åœ°ç†ä½ç½®è·å–é™„è¿‘çš„POIä¿¡æ¯

### åˆ›å»ºé«˜å¾·åœ°å›¾æœåŠ¡æ¨¡å—

```shell
mkdir -p src/build_mcp/services
touch src/build_mcp/services/__init__.py
touch src/build_mcp/services/gd_sdk.py
```

### ç¼–å†™é«˜å¾·åœ°å›¾æœåŠ¡ä»£ç 

```python
# src/build_mcp/services/gd_sdk.py
import asyncio
import logging
from typing import Any

import httpx


class GdSDK:
    """
    GdSDK API å¼‚æ­¥ SDK å°è£…ã€‚
  
    æ”¯æŒè‡ªåŠ¨é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ç­–ç•¥ã€‚
  
    Args:
        config (dict): é…ç½®å­—å…¸ï¼Œç¤ºä¾‹ï¼š
            {
                "base_url": "https://restapi.amap.com",
                "api_key": "your_api_key",
                "proxies": {"http": "...", "https": "..."},  # å¯é€‰
                "max_retries": 5,
                "retry_delay": 1,
                "backoff_factor": 2,
            }
        logger (logging.Logger, optional): æ—¥å¿—è®°å½•å™¨ï¼Œé»˜è®¤ä½¿ç”¨æ¨¡å— loggerã€‚
    """

    def __init__(self, config: dict, logger=None):
        self.api_key = config.get("api_key", "")
        self.base_url = config.get("base_url", "").rstrip('/')
        self.proxy = config.get("proxy", None)
        self.logger = logger or logging.getLogger(__name__)
        self.max_retries = config.get("max_retries", 5)
        self.retry_delay = config.get("retry_delay", 1)
        self.backoff_factor = config.get("backoff_factor", 2)

        # åˆ›å»ºä¸€ä¸ªå¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œè‡ªåŠ¨å¸¦ä¸Šè¯·æ±‚å¤´å’Œä»£ç†é…ç½®
        self._client = httpx.AsyncClient(proxy=self.proxy, timeout=10)

    async def __aenter__(self):
        return self

    async def __aexit__(self, exc_type, exc, tb):
        await self._client.aclose()

    def _should_retry(self, response: httpx.Response = None, exception: Exception = None) -> bool:
        """
        åˆ¤æ–­è¯·æ±‚å¤±è´¥åæ˜¯å¦åº”è¯¥é‡è¯•ã€‚
    
        Args:
            response (httpx.Response, optional): HTTP å“åº”å¯¹è±¡ã€‚
            exception (Exception, optional): è¯·æ±‚å¼‚å¸¸ã€‚
    
        Returns:
            bool: æ˜¯å¦éœ€è¦é‡è¯•ã€‚
        """
        if exception is not None:
            # ç½‘ç»œå¼‚å¸¸ç­‰ï¼Œå»ºè®®é‡è¯•
            return True

        if response is not None and response.status_code in (429, 500, 502, 503, 504):
            # æœåŠ¡å™¨é”™è¯¯æˆ–è¯·æ±‚è¿‡å¤šï¼Œå»ºè®®é‡è¯•
            return True

        # å…¶ä»–æƒ…å†µä¸é‡è¯•
        return False

    async def _request_with_retry(self, method: str, url: str, params=None, json=None):
        """
        å‘é€HTTPè¯·æ±‚ï¼Œå¸¦è‡ªåŠ¨é‡è¯•å’ŒæŒ‡æ•°é€€é¿ã€‚
    
        Args:
            method (str): HTTPæ–¹æ³•ï¼Œå¦‚ 'GET', 'POST'ã€‚
            url (str): è¯·æ±‚URLã€‚
            params (dict, optional): URLæŸ¥è¯¢å‚æ•°ã€‚
            json (dict, optional): è¯·æ±‚ä½“JSONã€‚
    
        Returns:
            dict or None: æˆåŠŸæ—¶è¿”å›JSONè§£æç»“æœï¼Œå¤±è´¥è¿”å› Noneã€‚
        """
        for attempt in range(self.max_retries + 1):
            try:
                response = await self._client.request(
                    method=method,
                    url=url,
                    params=params,
                    json=json,
                )

                if response.status_code in [200, 201]:
                    # æˆåŠŸè¿”å›JSONæ•°æ®
                    return response.json()

                if not self._should_retry(response=response):
                    self.logger.error(f"è¯·æ±‚å¤±è´¥ä¸”ä¸å¯é‡è¯•ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}ï¼ŒURLï¼š{url}")
                    return None

                self.logger.warning(
                    f"è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š{response.status_code}ï¼‰ï¼Œ"
                    f"ç¬¬ {attempt + 1}/{self.max_retries} æ¬¡é‡è¯•ï¼ŒURLï¼š{url}"
                )

            except httpx.RequestError as e:
                self.logger.warning(
                    f"è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}ï¼Œ"
                    f"ç¬¬ {attempt + 1}/{self.max_retries} æ¬¡é‡è¯•ï¼ŒURLï¼š{url}"
                )

            # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡é‡è¯•ï¼ŒæŒ‰æŒ‡æ•°é€€é¿ç­‰å¾…
            if attempt < self.max_retries:
                delay = self.retry_delay * (self.backoff_factor ** attempt)
                await asyncio.sleep(delay)

        self.logger.error(f"æ‰€æœ‰é‡è¯•å¤±è´¥ï¼ŒURLï¼š{url}")
        return None

    async def close(self):
        """
        å…³é—­å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œé‡Šæ”¾èµ„æºã€‚
        """
        await self._client.aclose()

    async def locate_ip(self, ip: str = None) -> Any | None:
        """
        IPå®šä½æ¥å£
        https://lbs.amap.com/api/webservice/guide/api/ipconfig
    
        Args:
            ip (str, optional): è¦æŸ¥è¯¢çš„ IPï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è¯·æ±‚æ–¹å…¬ç½‘ IPã€‚
    
        Returns:
            dict: å®šä½ç»“æœï¼Œè‹¥å¤±è´¥åˆ™è¿”å› Noneã€‚
        """
        url = f"{self.base_url}/v3/ip"
        params = {
            "key": self.api_key,
        }
        if ip:
            params["ip"] = ip

        result = await self._request_with_retry(
            method="GET",
            url=url,
            params=params
        )

        if result and result.get("status") == "1":
            return result
        else:
            self.logger.error(f"IPå®šä½å¤±è´¥: {result}")
            return None

    async def search_nearby(self, location: str, keywords: str = "", types: str = "", radius: int = 1000, page_num: int = 1, page_size: int = 20) -> dict | None:
        """
        å‘¨è¾¹æœç´¢ï¼ˆæ–°ç‰ˆ POIï¼‰
        https://lbs.amap.com/api/webservice/guide/api-advanced/newpoisearch#t4
    
        Args:
            location (str): ä¸­å¿ƒç‚¹ç»çº¬åº¦ï¼Œæ ¼å¼ä¸º "lng,lat"
            keywords (str, optional): æœç´¢å…³é”®è¯
            types (str, optional): POI åˆ†ç±»
            radius (int, optional): æœç´¢åŠå¾„ï¼ˆç±³ï¼‰ï¼Œæœ€å¤§ 50000ï¼Œé»˜è®¤ 1000
            page_num (int, optional): é¡µç ï¼Œé»˜è®¤ 1
            page_size (int, optional): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20ï¼Œæœ€å¤§ 25
    
        Returns:
            dict | None: æœç´¢ç»“æœï¼Œå¤±è´¥æ—¶è¿”å› None
        """
        url = f"{self.base_url}/v5/place/around"
        params = {
            "key": self.api_key,
            "location": location,
            "keywords": keywords,
            "types": types,
            "radius": radius,
            "page_num": page_num,
            "page_size": page_size,
        }

        result = await self._request_with_retry(
            method="GET",
            url=url,
            params=params,
        )

        if result and result.get("status") == "1":
            return result
        else:
            self.logger.error(f"å‘¨è¾¹æœç´¢å¤±è´¥: {result}")
            return None

```

ä»£ç ä¸­å®ç°äº†ï¼š

- å¼‚æ­¥HTTPè¯·æ±‚ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¯•å’ŒæŒ‡æ•°é€€é¿
- `locate_ip` æ–¹æ³•ç”¨äºæ ¹æ®IPè·å–åœ°ç†ä½ç½®
- `search_nearby` å‘¨è¾¹æœç´¢æ–¹æ³•ï¼Œç”¨äºæ ¹æ®ç»çº¬åº¦è·å–é™„è¿‘çš„POIä¿¡æ¯

### ç¼–å†™é«˜å¾·åœ°å›¾æœåŠ¡æµ‹è¯•ä»£ç 

```shell
mkdir -p tests/services
touch tests/services/test_gd_sdk.py
```

```python
# tests/test_gd_sdk_real.py
import logging
import os

import pytest
import pytest_asyncio

from build_mcp.services.gd_sdk import GdSDK

API_KEY = os.getenv("API_KEY", "your_api_key_here")  # ä»ç¯å¢ƒå˜é‡è·å– API Keyï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼


@pytest_asyncio.fixture
async def sdk():
    config = {
        "base_url": "https://restapi.amap.com",
        "api_key": API_KEY,
        "max_retries": 2,
    }
    async with GdSDK(config, logger=logging.getLogger("GdSDK")) as client:
        yield client


@pytest.mark.asyncio
async def test_locate_ip(sdk):
    result = await sdk.locate_ip()
    assert result is not None, "locate_ip è¿”å› None"
    assert result.get("status") == "1", f"locate_ip è°ƒç”¨å¤±è´¥: {result}"
    assert "province" in result, "locate_ip è¿”å›ä¸­ä¸åŒ…å« province"


@pytest.mark.asyncio
async def test_search_nearby(sdk):
    result = await sdk.search_nearby(
        location="116.481488,39.990464",
        keywords="åŠ æ²¹ç«™",
        radius=3000,
        page_num=1,
        page_size=5
    )
    assert result is not None, "search_nearby è¿”å› None"
    assert result.get("status") == "1", f"search_nearby è°ƒç”¨å¤±è´¥: {result}"
    assert "pois" in result, "search_nearby è¿”å›ä¸­ä¸åŒ…å« pois"


```

### è¿è¡Œæµ‹è¯•

```shell
uv run pytest tests/services/test_gd_sdk.py
# å¦‚æœä½ æœ‰é«˜å¾·API Keyï¼Œå¯ä»¥ç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•
API_KEY=ä½ çš„key uv run pytest -s tests/services/test_gd_sdk.py
```

---

## ğŸš€ MCP æœåŠ¡çš„ä¸‰ç§ä¼ è¾“åè®®ç®€ä»‹

### 1. **`stdio`**

* **é€šä¿¡æ–¹å¼**ï¼šæœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šè¿‡æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼ˆstdin/stdoutï¼‰åŒå‘ä¼ è¾“ JSONâ€‘RPC æ¶ˆæ¯ï¼›
* **é€‚ç”¨åœºæ™¯**ï¼šæœ¬åœ°è°ƒç”¨å·¥å…·æˆ–å­è¿›ç¨‹ï¼Œå¦‚æ¡Œé¢åº”ç”¨ä¸­è½»é‡çº§é›†æˆï¼›
* **ä¼˜ç‚¹**ï¼šå»¶è¿Ÿä½ã€å®ç°ç®€å•ã€æ— éœ€ç½‘ç»œã€‚

---

### 2. **`SSE`ï¼ˆServerâ€‘Sent Eventsï¼ŒæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼‰**

* **é€šä¿¡æ–¹å¼**ï¼šåŸºäº HTTPï¼šå®¢æˆ·ç«¯ç”¨ `POST` å‘æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨é€šè¿‡ `GET` å»ºç«‹ `text/eventâ€‘stream` å•å‘æ¨é€ï¼›
* **å½“å‰çŠ¶æ€**ï¼šå±äºå·²å¼ƒç”¨ï¼ˆdeprecatedï¼‰ï¼Œä» MCP v2024â€‘11â€‘05 èµ·è¢«â€œstreamableâ€‘httpâ€å–ä»£ï¼Œä½†ä»ä¿ç•™å…¼å®¹æ€§æ”¯æŒï¼›
* **ä¼˜ç‚¹**ï¼šé€‚åˆæ—©æœŸè¿œç¨‹åœºæ™¯ä¸­ä»…éœ€æœåŠ¡å™¨æ¨é€çš„ç®€æ˜“å®ç°ï¼›
* **ç¼ºç‚¹**ï¼šä»…æœåŠ¡å™¨â†’å®¢æˆ·ç«¯å•å‘ï¼Œè¿æ¥ä¸æ”¯æŒæ–­ç‚¹æ¢å¤ã€‚

---

### 3. **`streamableâ€‘http`**

* **é€šä¿¡æ–¹å¼**ï¼šåŸºäº HTTP çš„åŒå‘ä¼ è¾“ï¼šå®¢æˆ·ç«¯é€šè¿‡ `POST` è¯·æ±‚ JSONâ€‘RPCï¼ŒæœåŠ¡å™¨å¯ä»¥è¿”å›ä¸€æ¬¡æ€§å“åº”ï¼ˆJSONï¼‰æˆ–æµå¼ SSE æ¶ˆæ¯ï¼Œå¦å¯é€šè¿‡ `GET` å»ºç«‹æœåŠ¡å™¨æ¨é€ï¼›
* **æ”¯æŒåŠŸèƒ½**ï¼š

    * å•ä¸€ `/mcp` ç«¯ç‚¹å¤„ç†æ‰€æœ‰é€šä¿¡ï¼›
    * ä¼šè¯ç®¡ç†ï¼ˆé€šè¿‡ `Mcpâ€‘Sessionâ€‘Id`ï¼‰ï¼›
    * æµæ–­ç‚¹ç»­ä¼ ä¸æ¶ˆæ¯é‡æ”¾ï¼ˆHTTP æ–­çº¿æ¢å¤æ”¯æŒ `Lastâ€‘Eventâ€‘ID`ï¼‰ï¼›
    * å‘åå…¼å®¹ SSEï¼›
* **å½“å‰çŠ¶æ€**ï¼šMCP v2025â€‘03â€‘26 èµ·é»˜è®¤æ¨èä½¿ç”¨ï¼Œé€‚ç”¨äºäº‘ç«¯å’Œè¿œç¨‹éƒ¨ç½²ï¼Œæ˜¯è¿œç¨‹åœºæ™¯çš„é¦–é€‰ï¼›([modelcontextprotocol.io][1])

---

### ğŸ“Š åè®®å¯¹æ¯”æ¦‚è§ˆ

| åè®®                  | é€šä¿¡æ–¹å‘         | ä½¿ç”¨åœºæ™¯    | ç‰¹æ€§äº®ç‚¹              | æ¨èç¨‹åº¦   |
|---------------------|--------------|---------|-------------------|--------|
| **stdio**           | åŒå‘ï¼ˆæœ¬åœ°ï¼‰       | æœ¬åœ°å­è¿›ç¨‹è°ƒç”¨ | ç®€å•ã€ä½å»¶è¿Ÿã€é›¶ç½‘ç»œä¾èµ–      | â­ æœ¬åœ°ä¼˜é€‰ |
| **SSE**             | å•å‘ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰  | æ—©æœŸè¿œç¨‹å®ç°  | å®ç°ç®€å•ï¼Œä½†ä¸æ”¯æŒæ¢å¤       | âš ï¸ å·²å¼ƒç”¨ |
| **streamableâ€‘http** | åŒå‘/å¯é€‰ SSE æ¨é€ | äº‘ç«¯/è¿œç¨‹äº¤äº’ | å•ç«¯ç‚¹ã€å¤šåŠŸèƒ½ã€æ–­ç‚¹ç»­ä¼ ã€å…¼å®¹æ€§å¼º | âœ… æ¨èä½¿ç”¨ |

---

[1]: https://modelcontextprotocol.io/docs/concepts/transports?utm_source=chatgpt.com "Transports - Model Context Protocol"

## ç¼–å†™ MCP æœåŠ¡ä¸»ç¨‹åº

æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™ MCP æœåŠ¡çš„ä¸»ç¨‹åºï¼Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¹¶è°ƒç”¨é«˜å¾·åœ°å›¾ SDKã€‚

```shell
touch src/build_mcp/services/server.py
```

```python
import os
from typing import Any, Dict

from mcp.server.fastmcp import FastMCP

from build_mcp.common.config import load_config
from build_mcp.common.logger import get_logger
from build_mcp.services.gd_sdk import GdSDK

# ä¼˜å…ˆä»ç¯å¢ƒå˜é‡é‡Œè¯»å–API_KEYï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»é…ç½®æ–‡ä»¶è¯»å–
env_api_key = os.getenv("API_KEY")
config = load_config("config.yaml")
if env_api_key:
    config["api_key"] = env_api_key
mcp = FastMCP("amap-maps", description="é«˜å¾·åœ°å›¾ MCP æœåŠ¡", version="1.0.0")
sdk = GdSDK(config=config, logger=get_logger(name="gd_sdk", log_file="gd_sdk.log", log_level=config.get("log_level", "INFO")))
logger = get_logger(name="amap-maps", log_file="amap_maps.log", log_level=config.get("log_level", "INFO"))


@mcp.tool(name="locate_ip", description="æ ¹æ® IP åœ°å€å®šä½ä½ç½®")
async def locate_ip(ip="") -> Dict[str, Any]:
    """
    æ ¹æ® IP åœ°å€å®šä½ä½ç½®ã€‚
  
    Args:
        ip (str): è¦å®šä½çš„ IP åœ°å€ã€‚
  
    Returns:
        dict: åŒ…å«å®šä½ç»“æœçš„å­—å…¸ã€‚
    """
    logger.info(f"Locating IP: {ip}")
    try:
        result = await sdk.locate_ip(ip)
        if not result:
            return {"error": "get locate ip result is empty , please check your log."}
        logger.info(f"Locate IP result: {result}")
        return result
    except Exception as e:
        logger.error(f"Error locating IP {ip}: {e}")
        return {"error": str(e)}


@mcp.tool(name="search_nearby", description="å‘¨è¾¹æœç´¢")
async def search_nearby(location: str, keywords: str = "", types: str = "", radius: int = 1000, page_num: int = 1, page_size: int = 20) -> Dict[str, Any]:
    """
     å‘¨è¾¹æœç´¢ã€‚
  
     Args:
         location (str): ä¸­å¿ƒç‚¹ç»çº¬åº¦ï¼Œæ ¼å¼ä¸º "lng,lat"ã€‚
         keywords (str, optional): æœç´¢å…³é”®è¯ï¼Œé»˜è®¤ä¸ºç©ºã€‚
         types (str, optional): POI åˆ†ç±»ï¼Œé»˜è®¤ä¸ºç©ºã€‚
         radius (int, optional): æœç´¢åŠå¾„ï¼ˆç±³ï¼‰ï¼Œæœ€å¤§ 50000ï¼Œé»˜è®¤ä¸º 1000ã€‚
         page_num (int, optional): é¡µç ï¼Œé»˜è®¤ä¸º 1ã€‚
         page_size (int, optional): æ¯é¡µæ•°é‡ï¼Œæœ€å¤§ 25ï¼Œé»˜è®¤ä¸º 10ã€‚
  
     Returns:
         dict: åŒ…å«æœç´¢ç»“æœçš„å­—å…¸ã€‚
    """
    logger.info(f"Searching nearby: location={location}, keywords={keywords}, types={types}, radius={radius}, page_num={page_num}, page_size={page_size}")
    try:
        result = await sdk.search_nearby(location=location, keywords=keywords, types=types, radius=radius, page_num=page_num, page_size=page_size)
        if not result:
            return {"error": "search nearby result is empty , please check your log."}
        logger.info(f"Search nearby result: {result}")
        return result
    except Exception as e:
        logger.error(f"Error searching nearby: {e}")
        return {"error": str(e)}


```

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† MCP æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™æœåŠ¡å…¥å£ï¼Œå¯åŠ¨ MCP æœåŠ¡ã€‚

### ç¼–å†™ MCP æœåŠ¡å…¥å£

```shell
touch src/build_mcp/__init__.py
```

```python
# src/build_mcp/__init__.py
import argparse
import asyncio

from build_mcp.common.logger import get_logger
from build_mcp.services.server import mcp


def main():
    """Main function to run the MCP server."""
    logger = get_logger('app')

    parser = argparse.ArgumentParser(description="Amap MCP Server")
    parser.add_argument(
        'transport',
        nargs='?',
        default='stdio',
        choices=['stdio', 'sse', 'streamable-http'],
        help='Transport type (stdio, sse, or streamable-http)'
    )
    args = parser.parse_args()

    logger.info(f"ğŸš€ Starting MCP server with transport type: %s", args.transport)

    try:
        mcp.run(transport=args.transport)
    except (KeyboardInterrupt, asyncio.CancelledError):
        logger.info("ğŸ›‘ MCP Server received shutdown signal. Cleaning up...")
    except Exception as e:
        logger.exception("âŒ MCP Server crashed with unhandled exception: %s", e)
    else:
        logger.info("âœ… MCP Server shut down cleanly.")


if __name__ == "__main__":
    main()

```

```shell
touch src/build_mcp/__main__.py
```

```python
# src/build_mcp/__main__.py
from build_mcp import main

if __name__ == "__main__":
    main()
```

### ä¿®æ”¹`pyproject.toml` æ–‡ä»¶

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "build-mcp"
version = "0.1.0"
description = "æ„å»º MCP æœåŠ¡å™¨"
readme = "README.md"
requires-python = ">=3.10"
dependencies = [
  "httpx>=0.28.1",
  "mcp[cli]>=1.9.4",
  "pytest>=8.4.1",
  "pytest-asyncio>=1.0.0",
  "pyyaml>=6.0.2",
]

[tool.pytest.ini_options]
pythonpath = ["src"]
testpaths = ["tests"]

[project.scripts]
build_mcp = "build_mcp.__main__:main"

[tool.hatch.build.targets.wheel]
packages = ["src/build_mcp"]
```

å…¶ä¸­é‡ç‚¹ä¸º

```
[project.scripts]
build_mcp = "build_mcp.__main__:main"
```

è¿™è¡¨ç¤ºï¼š
> æ‰§è¡Œ build_mcp å‘½ä»¤æ—¶ï¼Œä¼šç­‰ä»·äºè¿è¡Œï¼š

```python
from build_mcp import main
main()
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è¿è¡Œ MCP æœåŠ¡ï¼š

- å¯åŠ¨stdioåè®®çš„MCPæœåŠ¡ï¼š
```shell
uv run build_mcp
```

- å¯åŠ¨streamable-httpåè®®çš„MCPæœåŠ¡ï¼š
```shell
uv run build_mcp streamable-http
```


## è°ƒè¯•MCPæœåŠ¡

å¦‚ä½•è°ƒè¯•MCPæœåŠ¡å–å†³ä¸æˆ‘ä»¬å¯åŠ¨æœåŠ¡çš„æ–¹å¼ã€‚

### 1.ç¼–å†™å®¢æˆ·ç«¯ä»£ç è¿›è¡Œè°ƒè¯•stdioåè®®çš„MCPæœåŠ¡

```shell
mkdir -p tests/services
touch tests/services/test_mcp_client.py
```

```python
import pytest
from mcp.client.session import ClientSession
from mcp.client.stdio import StdioServerParameters, stdio_client


@pytest.mark.asyncio
async def test_mcp_server():
    async with stdio_client(
            StdioServerParameters(command="uv", args=["run", "build_mcp"])
    ) as (read, write):
        print("å¯åŠ¨æœåŠ¡ç«¯...")

        async with ClientSession(read, write) as session:
            await session.initialize()
            print("åˆå§‹åŒ–å®Œæˆ")

            tools = await session.list_tools()
            print("å¯ç”¨å·¥å…·ï¼š", tools)

            assert hasattr(tools, "tools")
            assert isinstance(tools.tools, list)
            assert any(tool.name == "locate_ip" for tool in tools.tools)
```

#### è¿è¡Œæµ‹è¯•

```shell
API_KEY=ä½ çš„API_KEY uv run pytest -s tests/services/test_mcp_client.py 
```

è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»£ç çš„ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¼–å†™æ›´å¤šçš„æµ‹è¯•ä»£ç æ¥éªŒè¯MCPæœåŠ¡çš„åŠŸèƒ½ã€‚

### 2.ä½¿ç”¨Inspectorè¿›è¡Œæµ‹è¯•
Inspectoræ˜¯å®˜æ–¹æä¾›çš„ä¸€ä¸ªMCPæœåŠ¡è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥å¯åŠ¨ä¸€ä¸ªæœ¬åœ°webç•Œé¢ï¼Œåœ¨ç•Œé¢ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨MCPæœåŠ¡çš„å·¥å…·ã€‚
ç›¸å¯¹æ›´åŠ ç›´è§‚å’Œæ˜“ç”¨ï¼Œæ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼ï¼Œè¯¦æƒ…å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://modelcontextprotocol.io/docs/tools/inspector)ã€‚

```shell
# ä½¿ç”¨Inspectorè°ƒè¯•stdioåè®®çš„MCPæœåŠ¡
API_KEY=3a1391561548f8a8f464e82d235f64ce mcp dev src/build_mcp/__init__.py
```

## ç¼–å†™Makefile
ä¸ºäº†æ–¹ä¾¿å¼€å‘å’Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªMakefileæ¥ç®¡ç†å¸¸ç”¨çš„å‘½ä»¤ã€‚

```shell
touch Makefile
```

```makefile
# Makefile for MCP Service

# é»˜è®¤ç›®æ ‡ - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
.DEFAULT_GOAL := help

# é¡¹ç›®ç¯å¢ƒå˜é‡
API_KEY ?= your_api_key_here  # é»˜è®¤æµ‹è¯•ç”¨çš„ API_KEY

# å®‰è£…é¡¹ç›®ä¾èµ–
install:
	@echo "Installing project dependencies..."
	uv pip install -e .

# è¿è¡Œæµ‹è¯• (éœ€è¦è®¾ç½® API_KEY)
test:
	@echo "Running tests with API_KEY=$(API_KEY)..."
	API_KEY=$(API_KEY) uv run pytest -s tests

# å¯åŠ¨ stdio åè®®çš„ MCP æœåŠ¡
stdio:
	@echo "Starting MCP service with stdio protocol..."
	uv run build_mcp

# å¯åŠ¨ streamable-http åè®®çš„ MCP æœåŠ¡
http:
	@echo "Starting MCP service with streamable-http protocol..."
	uv run build_mcp streamable-http

# dev
dev:
	@echo "Starting MCP service with stdio protocol in development mode..."
	API_KEY=$(API_KEY) mcp dev src/build_mcp/__init__.py

# åˆ«åç›®æ ‡
streamable-http: http

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "MCP Service Management"
	@echo ""
	@echo "Usage:"
	@echo "  make install        Install project dependencies"
	@echo "  make test           Run tests (set API_KEY in Makefile or override)"
	@echo "  make stdio          Start MCP service with stdio protocol"
	@echo "  make http           Start MCP service with streamable-http protocol"
	@echo ""
	@echo "Advanced:"
	@echo "  Override API_KEY:   make test API_KEY=custom_key"
	@echo "  Clean:              make clean"
	@echo "  Full setup:         make setup"

# æ¸…ç†é¡¹ç›®
clean:
	@echo "Cleaning project..."
	rm -rf build dist *.egg-info
	find . -name '*.pyc' -exec rm -f {} +
	find . -name '*.pyo' -exec rm -f {} +
	find . -name '__pycache__' -exec rm -rf {} +

# å®Œæ•´è®¾ç½®ï¼šæ¸…ç† + å®‰è£… + æµ‹è¯•
setup: clean install test
	@echo "Project setup completed!"

# å£°æ˜ä¼ªç›®æ ‡
.PHONY: install test stdio http streamable-http help clean setup
```

ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»ä»0åˆ°1å®Œæ•´å¼€å‘å®Œäº†ä¸€æ•´ä¸ªMCPæœåŠ¡ï¼Œæ­å–œè‡ªå·±åˆå­¦ä¼šäº†ä¸€ä¸ªæ–°æŠ€èƒ½ï¼

## å¦‚ä½•ä½¿ç”¨è¿™ä¸ªMCPæœåŠ¡ï¼Ÿ
é¦–å…ˆä½ å¾—æ‹¥æœ‰ä¸€ä¸ªMCPå®¢æˆ·ç«¯ï¼Œç›®å‰å¸‚åœºä¸Šå„ç§ç±»å‹å¾—MCPå®¢æˆ·ç«¯å±‚å‡ºä¸ç©·ï¼Œè‡³äºç”¨ä»€ä¹ˆå…¨å‡­ä½ çš„çˆ±å¥½äº†ã€‚

è¿™é‡Œæœ‰ä¸€ä»½éå¸¸è¯¦ç»†çš„MCPå®¢æˆ·ç«¯ä½¿ç”¨æ”»ç•¥ï¼Œæ˜¯githubä¸Šä¸€ä¸ªéå¸¸æ£’çš„é¡¹ç›®ï¼š[MCPå®¢æˆ·ç«¯ä½¿ç”¨æ”»ç•¥](https://github.com/yzfly/Awesome-MCP-ZH)

é€‰æ‹©ä¸€ä¸ªå®¢æˆ·ç«¯ä¸‹è½½å®‰è£…ï¼Œç„¶åæˆ‘ä»¬å¯¹æˆ‘ä»¬å¼€å‘çš„æœåŠ¡è¿›è¡Œé…ç½®ã€‚

### é…ç½®Stdioåè®®çš„MCPæœåŠ¡

```shell
{
    "mcpServers": {
        "build_mcp": {
            "command": "uv",
            "args": [
                "run",
                "-m"
                "build_mcp"
            ],
            "env": {
                "API_KEY": "ä½ çš„é«˜å¾·API Key"
            }
        }
    }
}
```
## å‘å¸ƒåŒ…åˆ°PyPI
åœ¨å®Œæˆå¼€å‘å’Œæµ‹è¯•åï¼Œæˆ‘ä»¬å¯ä»¥å°†é¡¹ç›®æ‰“åŒ…å¹¶å‘å¸ƒåˆ° PyPI ä¸Šï¼Œä¾›å…¶ä»–äººä½¿ç”¨ã€‚

### æ‰“åŒ…é¡¹ç›®
```shell
uv run hatch build
```

### å‘å¸ƒåˆ° PyPI
é¦–å…ˆéœ€è¦åœ¨ PyPI ä¸Šåˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª API Tokenã€‚ç„¶åå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†åŒ…å‘å¸ƒåˆ° PyPIï¼š

```shell
uv run hatch publish --repository pypi
```

### å‘å¸ƒåˆ° Test PyPI
å¦‚æœä½ æƒ³å…ˆåœ¨ Test PyPI ä¸Šæµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```shell
  




